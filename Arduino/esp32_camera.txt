#include "esp_camera.h"
#include <Arduino.h>

// ======================= PINES ==========================
#define VALVE_SMALL 12
#define VALVE_MEDIUM 13
#define VALVE_LARGE 2

#define MOTOR_IN1 14
#define MOTOR_IN2 15

#define BTN_START 1   // BOTÓN 1 → START
#define BTN_STOP  3   // BOTÓN 3 → STOP

// ======================= VARIABLES ==========================
bool systemEnabled = false;
bool processingBox = false;

unsigned long lastDetectTime = 0;
const int DOUBLE_BOX_TIMEOUT = 400;

// ======================= RANGOS EN PIXELES ==========================
// Pequeña: 27–68 px
// Mediana: 81–108 px
// Grande: 121–175 px

const int SMALL_MIN_PX = 27;
const int SMALL_MAX_PX = 68;

const int MEDIUM_MIN_PX = 81;
const int MEDIUM_MAX_PX = 108;

const int LARGE_MIN_PX = 121;
const int LARGE_MAX_PX = 175;

// ===========================================================
//   MOTOR CONTROL
// ===========================================================
void motorStop() {
  digitalWrite(MOTOR_IN1, LOW);
  digitalWrite(MOTOR_IN2, LOW);
}

void motorForward() {
  digitalWrite(MOTOR_IN1, HIGH);
  digitalWrite(MOTOR_IN2, LOW);
}

// ===========================================================
//   VÁLVULAS
// ===========================================================
void closeAllValves() {
  digitalWrite(VALVE_SMALL, LOW);
  digitalWrite(VALVE_MEDIUM, LOW);
  digitalWrite(VALVE_LARGE, LOW);
}

void activateValve(int zone) {
  closeAllValves();

  if (zone == 1) digitalWrite(VALVE_SMALL, HIGH);
  if (zone == 2) digitalWrite(VALVE_MEDIUM, HIGH);
  if (zone == 3) digitalWrite(VALVE_LARGE, HIGH);
}

// ===========================================================
//   DETECCIÓN COLOR SIMPLE  (se mantiene igual)
// ===========================================================
String detectColor(uint8_t r, uint8_t g, uint8_t b) {
  if (b > r && b > g) return "AZUL";
  if (r > g && r > b) return "ROJO";
  if (r > 150 && g > 60 && b < 80) return "NARANJA";
  return "DESCONOCIDO";
}

// ===========================================================
//   CLASIFICACIÓN SOLO POR TAMAÑO
// ===========================================================
int classifyBox(String color, int pxHeight) {

  if (pxHeight >= SMALL_MIN_PX && pxHeight <= SMALL_MAX_PX)
    return 1; // pequeña

  if (pxHeight >= MEDIUM_MIN_PX && pxHeight <= MEDIUM_MAX_PX)
    return 2; // mediana

  if (pxHeight >= LARGE_MIN_PX && pxHeight <= LARGE_MAX_PX)
    return 3; // grande

  return 0; // nada válido
}

// ===========================================================
//   CÁMARA
// ===========================================================
void initCamera() {
  camera_config_t config;

  config.ledc_channel = LEDC_CHANNEL_0;
  config.ledc_timer   = LEDC_TIMER_0;

  config.pin_d0 = 5;
  config.pin_d1 = 18;
  config.pin_d2 = 19;
  config.pin_d3 = 21;
  config.pin_d4 = 36;
  config.pin_d5 = 39;
  config.pin_d6 = 34;
  config.pin_d7 = 35;
  config.pin_xclk = 0;
  config.pin_pclk = 22;
  config.pin_vsync = 25;
  config.pin_href = 23;
  config.pin_sccb_sda = 26;
  config.pin_sccb_scl = 27;
  config.pin_pwdn = 32;
  config.pin_reset = -1;

  config.xclk_freq_hz = 20000000;
  config.pixel_format = PIXFORMAT_RGB565;
  config.frame_size = FRAMESIZE_QVGA;
  config.fb_count = 1;

  esp_camera_init(&config);
}

// ===========================================================
//   SETUP
// ===========================================================
void setup() {
  Serial.begin(115200);

  pinMode(VALVE_SMALL, OUTPUT);
  pinMode(VALVE_MEDIUM, OUTPUT);
  pinMode(VALVE_LARGE, OUTPUT);
  closeAllValves();

  pinMode(MOTOR_IN1, OUTPUT);
  pinMode(MOTOR_IN2, OUTPUT);
  motorStop();

  pinMode(BTN_START, INPUT_PULLUP);
  pinMode(BTN_STOP, INPUT_PULLUP);

  initCamera();

  Serial.println("Sistema listo");
}

// ===========================================================
//   LOOP PRINCIPAL
// ===========================================================
void loop() {

  // STOP (botón 3)
  if (!digitalRead(BTN_STOP)) {
    systemEnabled = false;
    motorStop();
    closeAllValves();
    Serial.println(" STOP manual");
    delay(500);
  }

  // START (botón 1)
  if (!digitalRead(BTN_START)) {
    if (!systemEnabled) {
      systemEnabled = true;
      processingBox = false;
      closeAllValves();
      motorForward();
      Serial.println(" START manual");
      delay(500);
    }
  }

  if (!systemEnabled) return;

  // Leer frame
  camera_fb_t *fb = esp_camera_fb_get();
  if (!fb) return;

  int width = fb->width;
  int height = fb->height;
  uint8_t *buffer = fb->buf;

  int top = 9999;
  int bottom = 0;

  long sumR = 0, sumG = 0, sumB = 0;
  int count = 0;

  // Escaneo vertical
  for (int y = 0; y < height; y++) {
    for (int x = width / 3; x < 2 * width / 3; x++) {

      int i = (y * width + x) * 2;

      uint8_t byte1 = buffer[i];
      uint8_t byte2 = buffer[i + 1];

      uint8_t r = (byte1 & 0xF8);
      uint8_t g = ((byte1 & 0x07) << 5) | ((byte2 & 0xE0) >> 3);
      uint8_t b = (byte2 & 0x1F) << 3;

      if (r > 40 || g > 40 || b > 40) {
        if (y < top) top = y;
        if (y > bottom) bottom = y;

        sumR += r;
        sumG += g;
        sumB += b;
        count++;
      }
    }
  }

  esp_camera_fb_return(fb);

  int pxHeight = bottom - top;
  String color = "DESCONOCIDO";

  if (count > 50) color = detectColor(sumR / count, sumG / count, sumB / count);

  // Doble caja
  if (millis() - lastDetectTime < DOUBLE_BOX_TIMEOUT && pxHeight > 30) {
    Serial.println(" Doble caja → STOP");
    motorStop();
    systemEnabled = false;
    closeAllValves();
    return;
  }

  if (pxHeight > 30) lastDetectTime = millis();

  // Sin caja
  if (pxHeight < 30) {
    if (!processingBox) motorForward();
    return;
  }

  // Hay caja
  motorStop();

  if (!processingBox) {
    processingBox = true;

    int zone = classifyBox(color, pxHeight);

    Serial.print("Color: "); Serial.print(color);
    Serial.print(" | Altura(px): "); Serial.print(pxHeight);
    Serial.print(" | Zona: "); Serial.println(zone);

    activateValve(zone);

    delay(1500);
    closeAllValves();

    Serial.println(" Caja procesada");
    systemEnabled = false; // Esperar START
  }
}